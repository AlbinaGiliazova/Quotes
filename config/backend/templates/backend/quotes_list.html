{% extends 'base.html' %}

{% block content %}
  <h2>–í—Å–µ —Ü–∏—Ç–∞—Ç—ã</h2>
  <a href="{% url 'add_quote' %}">–î–æ–±–∞–≤–∏—Ç—å —Ü–∏—Ç–∞—Ç—É</a>

  <ul>
    {% for quote in quotes %}
      <li class="quote" data-id="{{ quote.id }}">
        <strong>{{ quote.text }}</strong><br>
        <em>–ò—Å—Ç–æ—á–Ω–∏–∫:</em> <a href="{% url 'source_detail' quote.source.id %}">{{ quote.source }}</a><br>
        <em>–í–µ—Å:</em> {{ quote.weight }}
        <div>
      {% if user.is_authenticated %}
  <button class="like-btn">üëç</button>
  <span class="like-count">{{ quote.likes_count }}</span>
  <button class="dislike-btn">üëé</button>
  <span class="dislike-count">{{ quote.dislikes_count }}</span>
{% else %}
  <button class="like-btn" disabled>üëç</button>
  <span class="like-count">{{ quote.likes_count }}</span>
  <button class="dislike-btn" disabled>üëé</button>
  <span class="dislike-count">{{ quote.dislikes_count }}</span>
  <span> (–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å)</span>
{% endif %}
    </div>
      </li>
    {% empty %}
      <li>–¶–∏—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç.</li>
    {% endfor %}
  </ul>
  <p>
    <a href="{% url 'source_list' %}">
      <button type="button">–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</button>
    </a>
  </p>
  {% if user.is_authenticated %}
  <p>–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
{% else %}
  <p>
    <a href="{% url 'login' %}">
      <button type="button">–í–æ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç</button>
    </a>
  </p>
{% endif %}
  <p><a href="{% url 'random_weighted_quote' %}">
    <button type="button">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é —Ü–∏—Ç–∞—Ç—É</button></a></p>
    <p><a href="{% url 'top_quotes' %}">
    <button type="button">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø-10 —Ü–∏—Ç–∞—Ç –ø–æ –ª–∞–π–∫–∞–º</button></a></p>
  {% if page_obj.has_other_pages %}
    <nav>
      <ul style="list-style: none; display: flex; gap: 5px; padding: 0;">
        {% if page_obj.has_previous %}
          <li><a href="?{% if source_query %}source={{ source_query }}&{% endif %}page=1">&laquo; –í –Ω–∞—á–∞–ª–æ</a></li>
          <li><a href="?{% if source_query %}source={{ source_query }}&{% endif %}page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a></li>
        {% endif %}

        <li>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</li>

        {% if page_obj.has_next %}
          <li><a href="?{% if source_query %}source={{ source_query }}&{% endif %}page={{ page_obj.next_page_number }}">–í–ø–µ—Ä—ë–¥</a></li>
          <li><a href="?{% if source_query %}source={{ source_query }}&{% endif %}page={{ page_obj.paginator.num_pages }}">–í –∫–æ–Ω–µ—Ü &raquo;</a></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

 <script>
    const csrfToken = '{{ csrf_token }}';

    document.querySelectorAll('.quote').forEach(function(el) {
        var quoteId = el.getAttribute('data-id');
        var likeBtn = el.querySelector('.like-btn');
        var dislikeBtn = el.querySelector('.dislike-btn');
        var likeCount = el.querySelector('.like-count');
        var dislikeCount = el.querySelector('.dislike-count');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞
        function sendVote(value) {
            fetch('{% url 'vote_quote' %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'quote_id': quoteId,
                    'value': value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    likeCount.textContent = data.likes;
                    dislikeCount.textContent = data.dislikes;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        likeBtn.addEventListener('click', function() {
            sendVote(1);
        });

        dislikeBtn.addEventListener('click', function() {
            sendVote(-1);
        });
    });
</script>

{% endblock %}