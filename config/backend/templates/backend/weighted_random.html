{% extends 'base.html' %}
{% block content %}
  <h2>–°–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞</h2>
  {% if quote %}
    <blockquote>{{ quote.text }}</blockquote>
    <p><em>{{ quote.source }}</em></p>
    <p>–í–µ—Å: {{ quote.weight }}</p>
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {{ quote.views }}</p>
    <div class="quote" data-id="{{ quote.id }}">
      {% if user.is_authenticated %}
        <button class="like-btn">üëç</button>
        <span class="like-count">{{ quote.likes_count }}</span>
        <button class="dislike-btn">üëé</button>
        <span class="dislike-count">{{ quote.dislikes_count }}</span>
      {% else %}
        <button class="like-btn" disabled>üëç</button>
        <span class="like-count">{{ quote.likes_count }}</span>
        <button class="dislike-btn" disabled>üëé</button>
        <span class="dislike-count">{{ quote.dislikes_count }}</span>
        <span> (–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å)</span>
      {% endif %}
    </div>
  {% else %}
    <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–∏—Ç–∞—Ç.</p>
  {% endif %}
  <p><a href="{% url 'random_weighted_quote' %}">–ü–æ–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥—É—é</a></p>
  <p><a href="{% url 'quotes_list' %}">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ü–∏—Ç–∞—Ç</a></p>

<script>
const csrfToken = '{{ csrf_token }}';
document.querySelectorAll('.quote').forEach(function(el) {
    var quoteId = el.getAttribute('data-id');
    var likeBtn = el.querySelector('.like-btn');
    var dislikeBtn = el.querySelector('.dislike-btn');
    var likeCount = el.querySelector('.like-count');
    var dislikeCount = el.querySelector('.dislike-count');

    function sendVote(value) {
        fetch('{% url 'vote_quote' %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'quote_id': quoteId,
                'value': value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                likeCount.textContent = data.likes;
                dislikeCount.textContent = data.dislikes;
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    if (likeBtn && dislikeBtn) {
        likeBtn.addEventListener('click', function() {
            sendVote(1);
        });

        dislikeBtn.addEventListener('click', function() {
            sendVote(-1);
        });
    }
});
</script>
{% endblock %}